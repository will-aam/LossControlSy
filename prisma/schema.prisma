// Sistema de Controle de Perdas - Prisma Schema
// APENAS MODELAGEM - NÃO EXECUTAR MIGRAÇÕES
// Preparado para integração futura com Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  FUNCIONARIO
  GESTOR
  FISCAL
  DONO
}

enum Unidade {
  UN
  KG
}

enum EventoStatus {
  RASCUNHO
  ENVIADO
  APROVADO
  REJEITADO
  EXPORTADO
}

enum ItemStatus {
  ATIVO
  INATIVO
}

// ============================================
// MODELS
// ============================================

/// Usuário do sistema
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  nome          String
  role          UserRole  @default(FUNCIONARIO)
  avatar        String?   /// URL da imagem de avatar
  ativo         Boolean   @default(true)
  criadoEm      DateTime  @default(now()) @map("criado_em")
  atualizadoEm  DateTime  @updatedAt @map("atualizado_em")

  // Relacionamentos
  eventosCriados   Evento[]  @relation("EventosCriados")
  eventosAprovados Evento[]  @relation("EventosAprovados")

  @@map("users")
}

/// Categoria de itens
model Categoria {
  id            String    @id @default(uuid())
  nome          String    @unique
  descricao     String?
  criadoEm      DateTime  @default(now()) @map("criado_em")
  atualizadoEm  DateTime  @updatedAt @map("atualizado_em")

  // Relacionamentos
  itens         Item[]
  subcategorias Subcategoria[]

  @@map("categorias")
}

/// Subcategoria de itens
model Subcategoria {
  id            String    @id @default(uuid())
  nome          String
  categoriaId   String    @map("categoria_id")
  criadoEm      DateTime  @default(now()) @map("criado_em")
  atualizadoEm  DateTime  @updatedAt @map("atualizado_em")

  // Relacionamentos
  categoria     Categoria @relation(fields: [categoriaId], references: [id])
  itens         Item[]

  @@unique([categoriaId, nome])
  @@map("subcategorias")
}

/// Item do catálogo de produtos
model Item {
  id              String      @id @default(uuid())
  codigoInterno   String      @unique @map("codigo_interno")
  codigoBarras    String?     @map("codigo_barras")
  nome            String
  categoriaId     String      @map("categoria_id")
  subcategoriaId  String?     @map("subcategoria_id")
  unidade         Unidade     @default(UN)
  custo           Decimal     @db.Decimal(10, 2)
  precoVenda      Decimal     @map("preco_venda") @db.Decimal(10, 2)
  imagemUrl       String?     @map("imagem_url") /// URL externa (ToDo Friendly)
  status          ItemStatus  @default(ATIVO)
  criadoEm        DateTime    @default(now()) @map("criado_em")
  atualizadoEm    DateTime    @updatedAt @map("atualizado_em")

  // Relacionamentos
  categoria       Categoria     @relation(fields: [categoriaId], references: [id])
  subcategoria    Subcategoria? @relation(fields: [subcategoriaId], references: [id])
  eventos         Evento[]

  @@index([codigoBarras])
  @@index([categoriaId])
  @@index([status])
  @@map("itens")
}

/// Evento de perda (quebra/descarte)
model Evento {
  id                  String        @id @default(uuid())
  dataHora            DateTime      @default(now()) @map("data_hora")
  itemId              String?       @map("item_id") /// Opcional - pode registrar sem item
  quantidade          Decimal       @db.Decimal(10, 3)
  unidade             Unidade       @default(UN)
  custoSnapshot       Decimal?      @map("custo_snapshot") @db.Decimal(10, 2) /// Custo no momento do registro
  precoVendaSnapshot  Decimal?      @map("preco_venda_snapshot") @db.Decimal(10, 2) /// Preço de venda no momento
  motivo              String?       /// Descrição do motivo da perda
  status              EventoStatus  @default(RASCUNHO)
  criadoPorId         String        @map("criado_por_id")
  aprovadoPorId       String?       @map("aprovado_por_id")
  dataAprovacao       DateTime?     @map("data_aprovacao")
  dataExportacao      DateTime?     @map("data_exportacao")
  observacoes         String?       /// Observações adicionais
  criadoEm            DateTime      @default(now()) @map("criado_em")
  atualizadoEm        DateTime      @updatedAt @map("atualizado_em")

  // Relacionamentos
  item                Item?         @relation(fields: [itemId], references: [id])
  criadoPor           User          @relation("EventosCriados", fields: [criadoPorId], references: [id])
  aprovadoPor         User?         @relation("EventosAprovados", fields: [aprovadoPorId], references: [id])
  evidencias          Evidencia[]

  @@index([dataHora])
  @@index([status])
  @@index([itemId])
  @@index([criadoPorId])
  @@map("eventos")
}

/// Evidência fotográfica de um evento
model Evidencia {
  id            String    @id @default(uuid())
  eventoId      String    @map("evento_id")
  url           String    /// URL externa (ToDo Friendly)
  descricao     String?   /// Descrição opcional da foto
  ordem         Int       @default(0) /// Ordem de exibição
  dataUpload    DateTime  @default(now()) @map("data_upload")
  criadoEm      DateTime  @default(now()) @map("criado_em")

  // Relacionamentos
  evento        Evento    @relation(fields: [eventoId], references: [id], onDelete: Cascade)

  @@index([eventoId])
  @@map("evidencias")
}

/// Configurações do sistema
model Configuracao {
  id            String    @id @default(uuid())
  chave         String    @unique
  valor         String
  descricao     String?
  tipo          String    @default("string") /// string, number, boolean, json
  criadoEm      DateTime  @default(now()) @map("criado_em")
  atualizadoEm  DateTime  @updatedAt @map("atualizado_em")

  @@map("configuracoes")
}

/// Log de auditoria
model AuditLog {
  id            String    @id @default(uuid())
  tabela        String    /// Nome da tabela afetada
  registroId    String    @map("registro_id") /// ID do registro afetado
  acao          String    /// CREATE, UPDATE, DELETE
  dadosAntigos  Json?     @map("dados_antigos") /// Snapshot antes da alteração
  dadosNovos    Json?     @map("dados_novos") /// Snapshot após a alteração
  usuarioId     String?   @map("usuario_id") /// Quem executou a ação
  ip            String?   /// IP do usuário
  userAgent     String?   @map("user_agent")
  criadoEm      DateTime  @default(now()) @map("criado_em")

  @@index([tabela, registroId])
  @@index([usuarioId])
  @@index([criadoEm])
  @@map("audit_logs")
}

// ============================================
// VIEWS E ÍNDICES ADICIONAIS (Sugestões)
// ============================================

// Para relatórios de perdas por período:
// CREATE INDEX idx_eventos_data_status ON eventos(data_hora, status);

// Para busca full-text de itens:
// CREATE INDEX idx_itens_nome_gin ON itens USING gin(to_tsvector('portuguese', nome));

// View materializada para dashboard:
// CREATE MATERIALIZED VIEW perdas_por_categoria AS
// SELECT 
//   c.nome as categoria,
//   SUM(e.quantidade * e.custo_snapshot) as custo_total,
//   SUM(e.quantidade * e.preco_venda_snapshot) as preco_venda_total,
//   COUNT(*) as total_eventos
// FROM eventos e
// JOIN itens i ON e.item_id = i.id
// JOIN categorias c ON i.categoria_id = c.id
// WHERE e.status IN ('APROVADO', 'EXPORTADO')
// GROUP BY c.nome;
