// Configuração do Cliente e Banco de Dados
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- ENUMS (Opções fixas do sistema) ---

enum UserRole {
  dono
  gestor
  fiscal
  funcionario
}

enum EventoStatus {
  rascunho
  enviado
  aprovado
  rejeitado
  exportado
}

enum ItemUnidade {
  UN
  KG
  CX
  L
}

// --- MODELOS (Tabelas) ---

// Usuários do Sistema (Dono, Gerente, etc.)
model User {
  id           String   @id @default(uuid())
  nome         String
  email        String   @unique
  passwordHash String // Senha criptografada
  role         UserRole @default(funcionario)
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos Inversos
  eventosCriados   Evento[]     @relation("CriadoPor")
  eventosAprovados Evento[]     @relation("AprovadoPor")
  notasFiscais     NotaFiscal[]
  evidencias       Evidencia[] // Evidências avulsas da galeria enviadas por ele
  Configuracao     Configuracao[] // Geralmente só o dono terá uma, mas mantemos relação

  @@map("users")
}

// Categorias de Produtos
model Categoria {
  id        String   @id @default(uuid())
  nome      String   @unique
  descricao String?
  status    String   @default("ativa") // ativa, inativa
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  items Item[]

  @@map("categorias")
}

// Itens (Produtos)
model Item {
  id            String      @id @default(uuid())
  codigoInterno String      @unique
  codigoBarras  String?
  nome          String
  unidade       ItemUnidade @default(UN)
  custo         Decimal     @db.Decimal(10, 2) // Ex: 12345.67
  precoVenda    Decimal     @db.Decimal(10, 2)
  imagemUrl     String?
  status        String      @default("ativo") // ativo, inativo
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Chave Estrangeira
  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id])

  // Relacionamentos
  eventos Evento[]

  @@map("items")
}

// Eventos de Perda/Quebra
model Evento {
  id        String       @id @default(uuid())
  dataHora  DateTime
  motivo    String?
  status    EventoStatus @default(rascunho)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Dados do Item (Snapshots para histórico financeiro)
  quantidade         Decimal @db.Decimal(10, 3) // Permite 1.500 KG
  unidade            String
  custoSnapshot      Decimal @db.Decimal(10, 2) // Custo no momento da perda
  precoVendaSnapshot Decimal @db.Decimal(10, 2) // Preço no momento da perda

  // Relacionamentos
  itemId String? // Opcional caso o item seja deletado (manter histórico)
  item   Item?   @relation(fields: [itemId], references: [id], onDelete: SetNull)

  criadoPorId String
  criadoPor   User   @relation("CriadoPor", fields: [criadoPorId], references: [id])

  aprovadoPorId String?
  aprovadoPor   User?   @relation("AprovadoPor", fields: [aprovadoPorId], references: [id])

  evidencias   Evidencia[]
  notasFiscais NotaFiscal[]

  @@map("eventos")
}

// Evidências (Fotos) - Galeria e Eventos
model Evidencia {
  id         String   @id @default(uuid())
  url        String // URL pública do Cloudflare R2
  motivo     String?
  dataUpload DateTime @default(now())

  // Relacionamentos
  eventoId String? // Se null, é uma "evidência avulsa" da galeria
  evento   Evento? @relation(fields: [eventoId], references: [id], onDelete: Cascade)

  userId String // Quem subiu a foto
  user   User   @relation(fields: [userId], references: [id])

  @@map("evidencias")
}

// Notas Fiscais (XML e PDF)
model NotaFiscal {
  id         String   @id @default(uuid())
  dataUpload DateTime @default(now())

  // Arquivos (Links do R2)
  pdfUrl     String?
  xmlUrl     String?
  xmlContent String? @db.Text // Conteúdo completo do XML para backup/leitura

  // Metadados extraídos
  numero           String?
  serie            String?
  emitente         String?
  cnpjEmitente     String?
  dataEmissao      DateTime? // Datetime para facilitar filtros
  valorTotal       Decimal?  @db.Decimal(12, 2)
  naturezaOperacao String?
  chaveAcesso      String?
  observacoes      String?

  // Relacionamentos
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  eventoId String? // Pode vincular a uma perda específica
  evento   Evento? @relation(fields: [eventoId], references: [id])

  @@map("notas_fiscais")
}
model Motivo {
  id        String   @id @default(uuid())
  nome      String   @unique // O texto do motivo (ex: "Validade Vencida")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("motivos")
}

// Configurações do Sistema (Singleton)
model Configuracao {
  id                         String  @id @default(uuid())
  empresaNome                String  @default("Minha Empresa")
  exigirFoto                 Boolean @default(false)
  bloquearAprovados          Boolean @default(true)
  limiteDiario               Decimal @default(1000.00) @db.Decimal(10, 2)
  permitirFuncionarioGaleria Boolean @default(false)

  // Vincula a configuração ao Dono (opcional, mas bom para multi-tenant futuro)
  donoId String @unique
  dono   User   @relation(fields: [donoId], references: [id])

  @@map("configuracoes")
}